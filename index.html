<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NMSTakvim</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Firebase SDK'ları -->
    <link rel="stylesheet" href="style.css">

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, query, where, onSnapshot, addDoc, updateDoc, deleteDoc, doc, Timestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // !!! BURAYI KENDİ FIREBASE PROJENİZİN AYARLARIYLA DOLDURUN !!!
        // Firebase projenizin ayarlarını buradan alabilirsiniz:
        // Firebase Konsolu -> Proje Ayarları -> Uygulamalarınız -> Web uygulaması -> Yapılandırma
        const firebaseConfig = {
            apiKey: "AIzaSyCTjxfKJevp5YUTLbR2Sjcuqa0Eq1DSyes",
            authDomain: "nmstakvim.firebaseapp.com",
            projectId: "nmstakvim",
            storageBucket: "nmstakvim.firebasestorage.app",
            messagingSenderId: "256075748103",
            appId: "1:256075748103:web:7b411e424c8b841d062ba2",
            measurementId: "G-PBX77J8TGW"
        };



        // Firebase Uygulamasını Başlat
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // Kaptanınızın Firebase Authentication'daki UID'si (Admin yetkisi için)
        // Yönetici hesabını oluşturduktan sonra bu UID'yi buraya yapıştıracaksınız.
        const ADMIN_UID = "2CRPV6IfosNzIFRTzg3a7GumWr72";

        // Global Firebase ve Auth nesnelerini erişilebilir yap
        window.firebaseApp = app;
        window.firebaseAuth = auth;
        window.firestoreDb = db;
        window.ADMIN_UID = ADMIN_UID;
    </script>
    
</head>
<body class="min-h-screen bg-gradient-to-br from-purple-900 via-indigo-900 to-blue-900 p-4 md:p-8 flex flex-col items-center justify-center font-inter">

    <div class="bg-white/10 backdrop-blur-lg rounded-3xl shadow-2xl p-6 md:p-10 w-full max-w-4xl border border-white/20">

        <h1 class="text-4xl md:text-5xl font-extrabold text-center mb-8 bg-clip-text text-transparent bg-gradient-to-r from-cyan-300/80 to-orange-500/80 drop-shadow-md">
            NMSTakvim
        </h1>


        <!-- Admin Giriş / Çıkış Bölümü -->
        <div class="flex justify-end mb-4">
            <div id="adminDurum" class="flex items-center space-x-2 text-white text-sm">
                <span id="kullaniciEposta" class="font-semibold text-cyan-200">Misafir</span>
                <button id="adminGirisCikisBtn" class="px-3 py-1 bg-blue-600 hover:bg-blue-700 text-white rounded-md transition-colors duration-200 shadow-lg shadow-blue-500/50">Giriş Yap</button>
            </div>
        </div>

        <div class="flex justify-between items-center mb-6 px-4">
            <button id="oncekiAyBtn" class="px-4 py-2 bg-indigo-600 hover:bg-indigo-700 text-white rounded-lg font-bold
              transition-all duration-300 shadow-lg shadow-indigo-500/50 hover:shadow-xl hover:shadow-indigo-500/70 neon-button-indigo">
                Önceki Ay
            </button>
            <h2 id="mevcutAyGoster" class="text-3xl font-bold text-white neon-text-subtle"></h2>
            <button id="sonrakiAyBtn" class="px-4 py-2 bg-indigo-600 hover:bg-indigo-700 text-white rounded-lg font-bold
              transition-all duration-300 shadow-lg shadow-indigo-500/50 hover:shadow-xl hover:shadow-indigo-500/70 neon-button-indigo">
                Sonraki Ay
            </button>
        </div>

        <div class="grid grid-cols-7 gap-2 text-white text-center mb-6">
            <div class="font-semibold text-lg text-cyan-300 neon-text-cyan">Pzt</div>
            <div class="font-semibold text-lg text-cyan-300 neon-text-cyan">Sal</div>
            <div class="font-semibold text-lg text-cyan-300 neon-text-cyan">Çar</div>
            <div class="font-semibold text-lg text-cyan-300 neon-text-cyan">Per</div>
            <div class="font-semibold text-lg text-cyan-300 neon-text-cyan">Cum</div>
            <div class="font-semibold text-lg text-cyan-300 neon-text-cyan">Cmt</div>
            <div class="font-semibold text-lg text-cyan-300 neon-text-cyan">Paz</div>
            <div id="takvimGunleriIzgara" class="contents">
            </div>
        </div>

        <div id="seciliTarihEtkinlikBolumu" class="mt-8 bg-white/10 backdrop-blur-lg rounded-2xl shadow-xl p-6 border border-white/20 hidden">
            <h3 id="seciliTarihGoster" class="text-3xl font-bold text-white mb-4 text-center neon-text"></h3>
            <button id="etkinlikEkleBtn" class="w-full px-6 py-3 mb-6 bg-purple-600 hover:bg-purple-700 text-white font-bold rounded-lg
              transition-all duration-300 shadow-lg shadow-purple-500/50 hover:shadow-xl hover:shadow-purple-500/70 neon-button-purple">
                + Yeni Etkinlik Ekle
            </button>
            <div id="etkinlikListesi" class="space-y-4">
            </div>
            <p id="etkinlikYokMesaji" class="text-white/70 text-center text-lg italic mt-4 hidden">Bu güne ait bir etkinlik bulunmamaktadır.</p>
        </div>
    </div>

    <!-- Admin Giriş Modalı -->
    <div id="adminGirisModali" class="fixed inset-0 bg-black/70 backdrop-blur-md flex items-center justify-center z-50 hidden p-4">
        <div class="bg-gradient-to-br from-indigo-900/40 to-purple-900/40 border border-indigo-400/20 rounded-3xl shadow-xl w-full max-w-md p-8 animate-fade-in-up transform scale-95 transition-all duration-300 neon-card-glow">
            <h2 class="text-3xl font-bold text-center text-white neon-text-subtle mb-6">Yönetici Girişi</h2>
            
            <form id="adminGirisFormu" class="space-y-6">
                <div>
                    <label for="adminEmail" class="block text-sm font-medium text-indigo-200 neon-text-subtle mb-2">E-posta Adresi</label>
                    <input type="email" id="adminEmail" required class="w-full p-3 bg-white/10 text-white rounded-xl border border-transparent focus:border-indigo-400 focus:bg-white/20 outline-none transition-all duration-300 neon-border-focus" placeholder="kaptan@ornek.com">
                </div>
                
                <div>
                    <label for="adminSifre" class="block text-sm font-medium text-indigo-200 neon-text-subtle mb-2">Şifre</label>
                    <input type="password" id="adminSifre" required class="w-full p-3 bg-white/10 text-white rounded-xl border border-transparent focus:border-indigo-400 focus:bg-white/20 outline-none transition-all duration-300 neon-border-focus" placeholder="••••••••">
                </div>
                
                <div class="flex justify-between space-x-4 pt-4">
                    <button type="button" id="adminGirisIptalBtn" class="flex-1 py-3 px-6 bg-red-600/70 hover:bg-red-700/80 text-white font-bold rounded-xl shadow-lg transition-all duration-300 neon-button-red">İptal</button>
                    <button type="submit" class="flex-1 py-3 px-6 bg-indigo-600/70 hover:bg-indigo-700/80 text-white font-bold rounded-xl shadow-lg transition-all duration-300 neon-button-indigo">Giriş Yap</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Etkinlik Formu Modalı -->
    <div id="etkinlikFormuModali" class="fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center z-50 p-4 hidden">
        <form id="etkinlikFormu" class="bg-white/10 p-6 rounded-xl shadow-2xl border border-white/20
          backdrop-blur-lg w-full max-w-md animate-fade-in-up">
            <h2 id="formBaslik" class="text-3xl font-bold text-white mb-6 text-center drop-shadow-lg neon-text"></h2>
            <input type="hidden" id="etkinlikId">
            <div class="mb-4">
                <label for="etkinlikBaslik" class="block text-white text-lg font-semibold mb-2 neon-text-subtle">
                    Başlık <span class="text-red-400">*</span>
                </label>
                <input
                    type="text"
                    id="etkinlikBaslik"
                    class="w-full p-3 rounded-lg bg-white/5 border border-white/10 text-white placeholder-gray-300 focus:outline-none focus:ring-2 focus:ring-indigo-400 neon-border-focus"
                    required
                    placeholder="Etkinlik Başlığı"
                />
            </div>
            <div class="mb-4">
                <label for="etkinlikLink" class="block text-white text-lg font-semibold mb-2 neon-text-subtle">
                    Link (Opsiyonel)
                </label>
                <input
                    type="url"
                    id="etkinlikLink"
                    class="w-full p-3 rounded-lg bg-white/5 border border-white/10 text-white placeholder-gray-300 focus:outline-none focus:ring-2 focus:ring-indigo-400 neon-border-focus"
                    placeholder="https://example.com"
                />
            </div>
            <div class="grid grid-cols-2 gap-4 mb-6">
                <div>
                    <label for="etkinlikTarih" class="block text-white text-lg font-semibold mb-2 neon-text-subtle">
                        Tarih <span class="text-red-400">*</span>
                    </label>
                    <input
                        type="date"
                        id="etkinlikTarih"
                        class="w-full p-3 rounded-lg bg-white/5 border border-white/10 text-white focus:outline-none focus:ring-2 focus:ring-indigo-400 neon-border-focus"
                        required
                    />
                </div>
                <div>
                    <label for="etkinlikSaat" class="block text-white text-lg font-semibold mb-2 neon-text-subtle">
                        Saat
                    </label>
                    <input
                        type="time"
                        id="etkinlikSaat"
                        class="w-full p-3 rounded-lg bg-white/5 border border-white/10 text-white focus:outline-none focus:ring-2 focus:ring-indigo-400 neon-border-focus"
                    />
                </div>
            </div>
            <div class="flex justify-end space-x-4">
                <button
                    type="button"
                    id="etkinlikIptalBtn"
                    class="px-6 py-3 bg-red-600 hover:bg-red-700 text-white font-bold rounded-lg
                    transition-all duration-300 shadow-lg shadow-red-500/50 hover:shadow-xl hover:shadow-red-500/70 neon-button-red"
                >
                    İptal
                </button>
                <button
                    type="submit"
                    class="px-6 py-3 bg-indigo-600 hover:bg-indigo-700 text-white font-bold rounded-lg
                    transition-all duration-300 shadow-lg shadow-indigo-500/50 hover:shadow-xl hover:shadow-indigo-500/70 neon-button-indigo"
                >
                    Kaydet
                </button>
            </div>
        </form>
    </div>

    <script type="module">
        import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, onSnapshot, addDoc, updateDoc, deleteDoc, doc, Timestamp, query } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global Firebase ve Auth nesnelerine erişim
        const auth = window.firebaseAuth;
        const db = window.firestoreDb;
        const ADMIN_UID = window.ADMIN_UID;

        let mevcutTarih = new Date();
        let seciliTarih = null;
        let etkinlikler = [];
        let adminGirisYapildiMi = false; // Admin giriş durumu

        const mevcutAyGoster = document.getElementById('mevcutAyGoster');
        const takvimGunleriIzgara = document.getElementById('takvimGunleriIzgara');
        const oncekiAyBtn = document.getElementById('oncekiAyBtn');
        const sonrakiAyBtn = document.getElementById('sonrakiAyBtn');
        const seciliTarihEtkinlikBolumu = document.getElementById('seciliTarihEtkinlikBolumu');
        const seciliTarihGoster = document.getElementById('seciliTarihGoster');
        const etkinlikEkleBtn = document.getElementById('etkinlikEkleBtn');
        const etkinlikListesi = document.getElementById('etkinlikListesi');
        const etkinlikYokMesaji = document.getElementById('etkinlikYokMesaji');

        const etkinlikFormuModali = document.getElementById('etkinlikFormuModali');
        const etkinlikFormu = document.getElementById('etkinlikFormu');
        const formBaslik = document.getElementById('formBaslik');
        const etkinlikIdInput = document.getElementById('etkinlikId');
        const etkinlikBaslikInput = document.getElementById('etkinlikBaslik');
        const etkinlikLinkInput = document.getElementById('etkinlikLink');
        const etkinlikTarihInput = document.getElementById('etkinlikTarih');
        const etkinlikSaatInput = document.getElementById('etkinlikSaat');
        const etkinlikIptalBtn = document.getElementById('etkinlikIptalBtn');

        const adminGirisModali = document.getElementById('adminGirisModali');
        const adminGirisFormu = document.getElementById('adminGirisFormu');
        const adminEmailInput = document.getElementById('adminEmail');
        const adminSifreInput = document.getElementById('adminSifre');
        const adminGirisIptalBtn = document.getElementById('adminGirisIptalBtn');
        const adminGirisCikisBtn = document.getElementById('adminGirisCikisBtn');
        const kullaniciEpostaGoster = document.getElementById('kullaniciEposta');

        function uuidOlustur() {
            return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
                var r = Math.random() * 16 | 0, v = c == 'x' ? r : (r & 0x3 | 0x8);
                return v.toString(16);
            });
        }

        // Firestore'dan etkinlikleri gerçek zamanlı olarak yükle
        function etkinlikleriYukle() {
            const etkinliklerKoleksiyonu = collection(db, 'events'); // 'events' koleksiyonunu kullanacağız
            onSnapshot(etkinliklerKoleksiyonu, (snapshot) => {
                etkinlikler = snapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data(),
                    date: doc.data().date.toDate() // Firestore Timestamp'i Date objesine dönüştür
                }));
                takvimiRenderEt();
                seciliTarihEtkinlikleriniRenderEt();
            }, (error) => {
                console.error("Etkinlikler yüklenirken hata oluştu:", error);
                gosterAlert("Etkinlikler yüklenirken bir sorun oluştu.");
            });
        }

        function takvimiRenderEt() {
            mevcutAyGoster.textContent = mevcutTarih.toLocaleString('tr-TR', { month: 'long', year: 'numeric' });
            takvimGunleriIzgara.innerHTML = '';

            const yil = mevcutTarih.getFullYear();
            const ay = mevcutTarih.getMonth();
            const ayinIlkGunu = new Date(yil, ay, 1).getDay();
            const ayinGunSayisi = new Date(yil, ay + 1, 0).getDate();

            const baslangicOfseti = (ayinIlkGunu === 0) ? 6 : ayinIlkGunu - 1;
            for (let i = 0; i < baslangicOfseti; i++) {
                const bosDiv = document.createElement('div');
                bosDiv.className = 'p-2 text-center text-gray-400';
                takvimGunleriIzgara.appendChild(bosDiv);
            }

            for (let i = 1; i <= ayinGunSayisi; i++) {
                const gunDiv = document.createElement('div');
                const gunTarih = new Date(yil, ay, i);

                gunDiv.dataset.date = gunTarih.toISOString().substring(0, 10);
                gunDiv.textContent = i;
                gunDiv.className = `p-2 text-center cursor-pointer transition-all duration-300 relative group`;

                const seciliMi = seciliTarih &&
                    seciliTarih.getDate() === i &&
                    seciliTarih.getMonth() === ay &&
                    seciliTarih.getFullYear() === yil;

                const etkinlikVarMi = etkinlikler.some(etkinlik => {
                    const etkinlikTarih = new Date(etkinlik.date);
                    return etkinlikTarih.getDate() === i &&
                           etkinlikTarih.getMonth() === ay &&
                           etkinlikTarih.getFullYear() === yil;
                });

                const bugun = new Date();
                const bugunMu = gunTarih.getDate() === bugun.getDate() &&
                                gunTarih.getMonth() === bugun.getMonth() &&
                                gunTarih.getFullYear() === bugun.getFullYear();

                if (seciliMi) {
                    gunDiv.classList.add('bg-indigo-600', 'text-white', 'rounded-lg', 'shadow-lg', 'shadow-indigo-500/50', 'transform', 'scale-105');
                } else if (bugunMu) {
                    gunDiv.classList.add('border-2', 'border-cyan-400', 'rounded-lg', 'text-white');
                } else if (etkinlikVarMi) {
                    gunDiv.classList.add('text-orange-300', 'font-bold');
                } else {
                    gunDiv.classList.add('text-white');
                }

                gunDiv.classList.add('hover:bg-indigo-700/50', 'hover:text-white', 'rounded-lg');

                if (etkinlikVarMi) {
                    const etkinlikNoktasi = document.createElement('span');
                    etkinlikNoktasi.className = 'absolute bottom-1 right-1 w-2 h-2 bg-pink-500 rounded-full animate-pulse group-hover:hidden';
                    gunDiv.appendChild(etkinlikNoktasi);
                }

                gunDiv.addEventListener('click', () => {
                    seciliTarih = gunTarih;
                    takvimiRenderEt();
                    seciliTarihEtkinlikleriniRenderEt();
                });
                takvimGunleriIzgara.appendChild(gunDiv);
            }
        }

        function seciliTarihEtkinlikleriniRenderEt() {
            if (!seciliTarih) {
                seciliTarihEtkinlikBolumu.classList.add('hidden');
                return;
            }

            seciliTarihEtkinlikBolumu.classList.remove('hidden');
            seciliTarihGoster.textContent = seciliTarih.toLocaleDateString('tr-TR', { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' });
            etkinlikListesi.innerHTML = '';

            const gunEtkinlikleri = etkinlikler.filter(etkinlik => {
                const etkinlikTarih = new Date(etkinlik.date);
                return etkinlikTarih.getDate() === seciliTarih.getDate() &&
                       etkinlikTarih.getMonth() === seciliTarih.getMonth() &&
                       etkinlikTarih.getFullYear() === seciliTarih.getFullYear();
            }).sort((a, b) => a.date - b.date);

            if (gunEtkinlikleri.length === 0) {
                etkinlikYokMesaji.classList.remove('hidden');
            } else {
                etkinlikYokMesaji.classList.add('hidden');
                gunEtkinlikleri.forEach(etkinlik => {
                    const etkinlikKarti = document.createElement('div');
                    etkinlikKarti.className = 'bg-white/15 backdrop-blur-md rounded-xl p-4 flex justify-between items-center border border-white/15 shadow-md shadow-black/20 neon-card-glow';
                    etkinlikKarti.innerHTML = `
                        <div>
                            <h4 class="text-xl font-bold text-white neon-text-cyan">${etkinlik.title}</h4>
                            <p class="text-sm text-gray-200 mt-1">${etkinlik.date.toLocaleTimeString('tr-TR', {hour: '2-digit', minute: '2-digit'})}</p>
                            ${etkinlik.link ? `<a href="${etkinlik.link}" target="_blank" rel="noopener noreferrer" class="text-indigo-300 hover:text-indigo-400 text-sm italic transition-colors duration-200">${etkinlik.link}</a>` : ''}
                        </div>
                        <div class="flex space-x-2">
                            <button data-id="${etkinlik.id}" class="duzenle-btn p-2 bg-yellow-500 hover:bg-yellow-600 text-white rounded-lg transition-colors duration-200 shadow-md neon-button-yellow">
                                <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="M13.586 3.586a2 2 0 112.828 2.828l-.793.793-2.828-2.828.793-.793zm-5.042 5.042L12.008 7.37l-2.829-2.829-3.447 3.447L3 10.5v-.917l5.042-5.042zM15 11a1 1 0 100-2 1 1 0 000 2zM3 13.5V17h3.5L16 6.5 12.5 3 3 13.5z"/></svg>
                            </button>
                            <button data-id="${etkinlik.id}" class="sil-btn p-2 bg-red-600 hover:bg-red-700 text-white rounded-lg transition-colors duration-200 shadow-md neon-button-red">
                                <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd"/></svg>
                            </button>
                        </div>
                    `;
                    etkinlikListesi.appendChild(etkinlikKarti);
                });
                yetkilendirmeDurumunaGoreDugmeleriGuncelle();
            }
        }

        function yetkilendirmeDurumunaGoreDugmeleriGuncelle() {
            const duzenleDugmeleri = document.querySelectorAll('.duzenle-btn');
            const silDugmeleri = document.querySelectorAll('.sil-btn');

            if (adminGirisYapildiMi) {
                etkinlikEkleBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                etkinlikEkleBtn.disabled = false;
                duzenleDugmeleri.forEach(btn => {
                    btn.classList.remove('opacity-50', 'cursor-not-allowed');
                    btn.disabled = false;
                    btn.addEventListener('click', (e) => {
                        const etkinlikId = e.currentTarget.dataset.id;
                        const duzenlenecekEtkinlik = etkinlikler.find(etkinlik => etkinlik.id === etkinlikId);
                        if (duzenlenecekEtkinlik) {
                            etkinlikFormunuAc(duzenlenecekEtkinlik);
                        }
                    });
                });
                silDugmeleri.forEach(btn => {
                    btn.classList.remove('opacity-50', 'cursor-not-allowed');
                    btn.disabled = false;
                    btn.addEventListener('click', (e) => {
                        const etkinlikId = e.currentTarget.dataset.id;
                        etkinligiSil(etkinlikId);
                    });
                });
            } else {
                etkinlikEkleBtn.classList.add('opacity-50', 'cursor-not-allowed');
                etkinlikEkleBtn.disabled = true;
                duzenleDugmeleri.forEach(btn => {
                    btn.classList.add('opacity-50', 'cursor-not-allowed');
                    btn.disabled = true;
                });
                silDugmeleri.forEach(btn => {
                    btn.classList.add('opacity-50', 'cursor-not-allowed');
                    btn.disabled = true;
                });
            }
        }

        function etkinlikFormunuAc(etkinlik = null) {
            etkinlikFormu.reset();
            etkinlikFormuModali.classList.remove('hidden');

            // Tarihi YYYY-MM-DD formatında almak için yardımcı fonksiyon
            const formatTarih = (tarih) => {
                const yil = tarih.getFullYear();
                // getMonth() 0'dan başladığı için 1 eklememiz gerekiyor.
                const ay = (tarih.getMonth() + 1).toString().padStart(2, '0');
                const gun = tarih.getDate().toString().padStart(2, '0');
                return `${yil}-${ay}-${gun}`;
            };

            if (etkinlik) {
                formBaslik.textContent = 'Etkinliği Düzenle';
                etkinlikIdInput.value = etkinlik.id;
                etkinlikBaslikInput.value = etkinlik.title;
                etkinlikLinkInput.value = etkinlik.link;
                // Düzenlerken, mevcut etkinliğin doğru tarihini kullan
                etkinlikTarihInput.value = formatTarih(etkinlik.date);
                etkinlikSaatInput.value = etkinlik.date.toTimeString().substring(0, 5);
            } else {
                formBaslik.textContent = 'Yeni Etkinlik Ekle';
                etkinlikIdInput.value = '';
                etkinlikBaslikInput.value = '';
                etkinlikLinkInput.value = '';
                // Yeni etkinlik eklerken, seçili tarihi kullan, yoksa bugünü kullan
                const varsayilanTarih = seciliTarih ? seciliTarih : new Date();
                etkinlikTarihInput.value = formatTarih(varsayilanTarih);
                etkinlikSaatInput.value = '';
            }
        }

        function etkinlikFormunuKapat() {
            etkinlikFormuModali.classList.add('hidden');
        }

        async function etkinligiKaydet(e) {
            e.preventDefault();

            const id = etkinlikIdInput.value;
            const baslik = etkinlikBaslikInput.value;
            const link = etkinlikLinkInput.value;
            const tarihStr = etkinlikTarihInput.value;
            const saatStr = etkinlikSaatInput.value || '00:00';

            const tarih = new Date(`${tarihStr}T${saatStr}:00`);

            if (!baslik || !tarihStr) {
                await gosterAlert("Başlık ve tarih boş bırakılamaz!");
                return;
            }

            try {
                if (id) {
                    // Firestore'da belgeyi güncelle
                    const belgeRef = doc(db, 'events', id);
                    await updateDoc(belgeRef, {
                        title: baslik,
                        link: link,
                        date: Timestamp.fromDate(tarih)
                    });
                } else {
                    // Firestore'a yeni belge ekle
                    await addDoc(collection(db, 'events'), {
                        title: baslik,
                        link: link,
                        date: Timestamp.fromDate(tarih)
                    });
                }
                etkinlikFormunuKapat();
                // Firestore onSnapshot listener'ı otomatik olarak UI'ı güncelleyecektir.
            } catch (error) {
                console.error("Etkinlik kaydedilirken hata oluştu:", error);
                await gosterAlert("Etkinlik kaydedilirken bir hata oluştu. Yönetici olarak giriş yaptığınızdan emin olun.");
            }
        }

        async function etkinligiSil(id) {
            const onay = await gosterOnay("Bu etkinliği silmek istediğinizden emin misiniz?");
            if (onay) {
                try {
                    // Firestore'dan belgeyi sil
                    const belgeRef = doc(db, 'events', id);
                    await deleteDoc(belgeRef);
                    // Firestore onSnapshot listener'ı otomatik olarak UI'ı güncelleyecektir.
                } catch (error) {
                    console.error("Etkinlik silinirken hata oluştu:", error);
                    await gosterAlert("Etkinlik silinirken bir hata oluştu. Yönetici olarak giriş yaptığınızdan emin olun.");
                }
            }
        }

        // Admin Giriş Fonksiyonları
        async function adminGirisYap(e) {
            e.preventDefault();
            const email = adminEmailInput.value;
            const password = adminSifreInput.value;

            try {
                await signInWithEmailAndPassword(auth, email, password);
                adminGirisModali.classList.add('hidden');
                // Kullanıcı durumu onAuthStateChanged ile güncellenecektir.
            } catch (error) {
                console.error("Giriş hatası:", error);
                let hataMesaji = "Giriş başarısız. Lütfen e-posta ve şifrenizi kontrol edin.";
                if (error.code === 'auth/user-not-found' || error.code === 'auth/wrong-password') {
                    hataMesaji = "Yanlış e-posta veya şifre.";
                } else if (error.code === 'auth/invalid-email') {
                    hataMesaji = "Geçersiz e-posta formatı.";
                }
                await gosterAlert(hataMesaji);
            }
        }

        async function adminCikisYap() {
            try {
                await signOut(auth);
                // Kullanıcı durumu onAuthStateChanged ile güncellenecektir.
            } catch (error) {
                console.error("Çıkış hatası:", error);
                await gosterAlert("Çıkış yapılırken bir hata oluştu.");
            }
        }

        // Kullanıcı yetkilendirme durumu değiştiğinde çalışır
        onAuthStateChanged(auth, (user) => {
            if (user && user.uid === ADMIN_UID) {
                adminGirisYapildiMi = true;
                kullaniciEpostaGoster.textContent = user.email;
                adminGirisCikisBtn.textContent = "Çıkış Yap";
                adminGirisCikisBtn.onclick = adminCikisYap;
                console.log("Admin olarak giriş yapıldı:", user.email);
            } else {
                adminGirisYapildiMi = false;
                kullaniciEpostaGoster.textContent = "Misafir";
                adminGirisCikisBtn.textContent = "Giriş Yap";
                adminGirisCikisBtn.onclick = () => adminGirisModali.classList.remove('hidden');
                console.log("Misafir olarak giriş yapıldı.");
            }
            yetkilendirmeDurumunaGoreDugmeleriGuncelle(); // Düğmeleri yetkiye göre güncelle
        });

        function olayDinleyicileriniAyarla() {
            oncekiAyBtn.addEventListener('click', () => {
                mevcutTarih.setMonth(mevcutTarih.getMonth() - 1);
                seciliTarih = null;
                takvimiRenderEt();
                seciliTarihEtkinlikBolumu.classList.add('hidden');
            });

            sonrakiAyBtn.addEventListener('click', () => {
                mevcutTarih.setMonth(mevcutTarih.getMonth() + 1);
                seciliTarih = null;
                takvimiRenderEt();
                seciliTarihEtkinlikBolumu.classList.add('hidden');
            });

            etkinlikEkleBtn.addEventListener('click', () => etkinlikFormunuAc(null));
            etkinlikIptalBtn.addEventListener('click', etkinlikFormunuKapat);
            etkinlikFormu.addEventListener('submit', etkinligiKaydet);

            adminGirisCikisBtn.addEventListener('click', () => adminGirisModali.classList.remove('hidden'));
            adminGirisIptalBtn.addEventListener('click', () => adminGirisModali.classList.add('hidden'));
            adminGirisFormu.addEventListener('submit', adminGirisYap);
        }

        window.onload = function() {
            etkinlikleriYukle(); // Etkinlikleri Firestore'dan yüklemeye başla
            olayDinleyicileriniAyarla();
        };

        function gosterAlert(mesaj) {
            return new Promise((resolve) => {
                const modalHtml = `
                    <div class="fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center z-[100] p-4">
                        <div class="bg-white/10 p-6 rounded-xl shadow-2xl border border-white/20 backdrop-blur-lg w-full max-w-sm animate-fade-in-up text-center">
                            <p class="text-white text-lg mb-6">${mesaj}</p>
                            <button class="px-6 py-3 bg-indigo-600 hover:bg-indigo-700 text-white font-bold rounded-lg transition-all duration-300 shadow-lg neon-button-indigo" onclick="this.parentNode.parentNode.remove(); resolve(true);">Tamam</button>
                        </div>
                    </div>
                `;
                document.body.insertAdjacentHTML('beforeend', modalHtml);
            });
        }

        function gosterOnay(mesaj) {
            return new Promise((resolve) => {
                const modalHtml = `
                    <div class="fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center z-[100] p-4">
                        <div class="bg-white/10 p-6 rounded-xl shadow-2xl border border-white/20 backdrop-blur-lg w-full max-w-sm animate-fade-in-up text-center">
                            <p class="text-white text-lg mb-6">${mesaj}</p>
                            <div class="flex justify-center space-x-4">
                                <button class="px-6 py-3 bg-red-600 hover:bg-red-700 text-white font-bold rounded-lg transition-all duration-300 shadow-lg neon-button-red" data-response="false">İptal</button>
                                <button class="px-6 py-3 bg-indigo-600 hover:bg-indigo-700 text-white font-bold rounded-lg transition-all duration-300 shadow-lg neon-button-indigo" data-response="true">Evet</button>
                            </div>
                        </div>
                    </div>
                `;
                document.body.insertAdjacentHTML('beforeend', modalHtml);

                const modal = document.querySelector('.z-\\[100\\]');
                modal.querySelectorAll('button').forEach(button => {
                    button.addEventListener('click', (e) => {
                        modal.remove();
                        resolve(e.target.dataset.response === 'true');
                    });
                });
            });
        }
    </script>
</body>
</html>
